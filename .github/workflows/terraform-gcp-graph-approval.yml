name: Terraform Plan with Color Graph (Safe Review Only)

on:
  pull_request:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you running this plan?"
        required: false
        default: "Manual Terraform plan run"

permissions:
  contents: read
  pull-requests: write

env:
  TF_WORKING_DIR: .
  TF_VERSION: 1.9.5

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      - name: Install Graphviz & jq
        run: sudo apt-get update && sudo apt-get install -y graphviz jq

      - name: Generate high-quality Terraform graph
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          set -e

          terraform graph -plan=tfplan.binary > base.dot

          echo 'digraph terraform {' > tfplan.dot
          echo '  rankdir=LR;' >> tfplan.dot
          echo '  node [shape=box style="rounded,filled" fontname="Helvetica"];' >> tfplan.dot
          echo '  edge [color="#999999"];' >> tfplan.dot

          jq -r '
            .resource_changes[] |
            .address as $addr |
            (.change.actions | join(",")) as $action |
            if $action == "create" then
              "\"\($addr)\" [fillcolor=\"#c7f5d9\" label=\"\($addr)\\n‚ûï CREATE\"];"
            elif $action == "update" then
              "\"\($addr)\" [fillcolor=\"#fff3bf\" label=\"\($addr)\\n‚úèÔ∏è UPDATE\"];"
            elif $action == "delete" then
              "\"\($addr)\" [fillcolor=\"#f8c7cc\" label=\"\($addr)\\n‚ùå DESTROY\"];"
            else
              "\"\($addr)\" [fillcolor=\"#e0e0e0\" label=\"\($addr)\"];"
            end
          ' tfplan.json >> tfplan.dot

          # Add dependency edges
          grep '->' base.dot >> tfplan.dot

          echo '}' >> tfplan.dot

          dot -Tpng tfplan.dot -o tfplan.png
          

      - name: Show graph in workflow summary
        run: |
          echo "## Terraform Plan ‚Äì Resource Graph" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Legend**" >> $GITHUB_STEP_SUMMARY
          echo "- üü¢ Create" >> $GITHUB_STEP_SUMMARY
          echo "- üü° Update" >> $GITHUB_STEP_SUMMARY
          echo "- üî¥ Destroy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìé **Download the full graph from artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- terraform-plan-graph ‚Üí tfplan.png" >> $GITHUB_STEP_SUMMARY


      - name: Terraform impact summary
        run: |
          CREATES=$(jq '[.resource_changes[] | select(.change.actions | index("create"))] | length' tfplan.json)
          UPDATES=$(jq '[.resource_changes[] | select(.change.actions | index("update"))] | length' tfplan.json)
          DESTROYS=$(jq '[.resource_changes[] | select(.change.actions | index("delete"))] | length' tfplan.json)

          echo "## Terraform Plan ‚Äì Impact Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Create | $CREATES |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Update | $UPDATES |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Destroy | $DESTROYS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DESTROYS" -gt 0 ]; then
            echo "‚ö†Ô∏è **WARNING: Destroy actions detected**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **No destroy actions detected**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Visual Resource Graph" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** \`terraform-plan-graph\`" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** \`tfplan.png\`" >> $GITHUB_STEP_SUMMARY
          echo "‚û°Ô∏è Workflow run ‚Üí Artifacts ‚Üí terraform-plan-graph ‚Üí tfplan.png" >> $GITHUB_STEP_SUMMARY


      - name: Upload plan & graph artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-graph
          path: |
            tfplan.binary
            tfplan.json
            tfplan.dot
            tfplan.png
          retention-days: 5

      - name: Comment graph on PR (PR only)
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.issue?.number) return;

            const fs = require('fs');
            const image = fs.readFileSync('tfplan.png', { encoding: 'base64' });

            const body = [
              '### Terraform Plan ‚Äì Visual Graph',
              '',
              '**Legend**',
              '- üü¢ Create',
              '- üü° Update',
              '- üî¥ Destroy',
              '',
              '<details>',
              '<summary>Click to expand</summary>',
              '',
              `<img src="data:image/png;base64,${image}" />`,
              '',
              '</details>',
              '',
              '‚ö†Ô∏è **Apply / Destroy are disabled. Manual approval required in separate workflow.**'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
