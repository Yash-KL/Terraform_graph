name: Terraform Plan (Review Only)

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  TF_WORKING_DIR: .
  TF_VERSION: 1.9.5

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout & Auth
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # ------------------------------------------------------------
      # Terraform Plan
      # ------------------------------------------------------------
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      # ------------------------------------------------------------
      # Graph generation (SVG)
      # ------------------------------------------------------------
      - name: Install Graphviz & jq
        run: sudo apt-get update && sudo apt-get install -y graphviz jq

      - name: Generate Terraform Dependency Graph (SVG)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform graph -plan=tfplan.binary > base.dot
          python3 scripts/colorize_tf_graph.py
          dot -Tsvg tfplan.dot -o tfplan.svg

      # ------------------------------------------------------------
      # Impact Summary (with resource names)
      # ------------------------------------------------------------
      - name: Terraform Impact Summary
        run: |
          echo "## Terraform Plan â€“ Impact Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count | Resources |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-----------|" >> $GITHUB_STEP_SUMMARY

          CREATES=$(jq -r '.resource_changes[] | select(.change.actions | index("create")) | .address' tfplan.json)
          UPDATES=$(jq -r '.resource_changes[] | select(.change.actions | index("update")) | .address' tfplan.json)
          DESTROYS=$(jq -r '.resource_changes[] | select(.change.actions | index("delete")) | .address' tfplan.json)

          CREATE_COUNT=$(echo "$CREATES" | grep -c . || true)
          UPDATE_COUNT=$(echo "$UPDATES" | grep -c . || true)
          DESTROY_COUNT=$(echo "$DESTROYS" | grep -c . || true)

          echo "| ğŸŸ¢ Create | $CREATE_COUNT | $(echo "$CREATES" | paste -sd ', ' -) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ¡ Update | $UPDATE_COUNT | $(echo "$UPDATES" | paste -sd ', ' -) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Destroy | $DESTROY_COUNT | $(echo "$DESTROYS" | paste -sd ', ' -) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DESTROY_COUNT" -gt 0 ]; then
            RISK="HIGH"
            echo "âš ï¸ **Destroy actions detected â€“ review carefully**" >> $GITHUB_STEP_SUMMARY
          elif [ "$UPDATE_COUNT" -gt 0 ]; then
            RISK="MEDIUM"
          else
            RISK="LOW"
            echo "âœ… **No destroy actions detected**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Risk Level:** ğŸ”¥ $RISK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Dependency graph: Artifacts â†’ terraform-plan-graph â†’ tfplan.svg" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: Upload plan & graph artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-graph
          path: |
            tfplan.binary
            tfplan.json
            tfplan.dot
            tfplan.svg
          retention-days: 5

      # ------------------------------------------------------------
      # PR Comment â€“ Mermaid Diagram (Managers)
      # ------------------------------------------------------------
      - name: PR Comment â€“ Mermaid Diagram (Managers)
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.issue?.number) return;

            const body = [
              '### Infrastructure Change Overview (High-Level)',
              '',
              '```mermaid',
              'flowchart LR',
              '  Plan[Terraform Changes]',
              '',
              '  CreateNet[ğŸŸ¢ New Networking]',
              '  CreateCompute[ğŸŸ¢ New Compute]',
              '  UpdateSec[ğŸŸ¡ Security Updates]',
              '  NoDestroy[âœ… No Resource Deletions]',
              '',
              '  Plan --> CreateNet',
              '  Plan --> CreateCompute',
              '  Plan --> UpdateSec',
              '  Plan --> NoDestroy',
              '```',
              '',
              '**Audience:** Managers / Tech Leads',
              '',
              '**Purpose:**',
              '- Quick understanding of the type of infrastructure changes',
              '- No dependency on specific resource names',
              '- Scales safely to large and unknown Terraform codebases',
              '',
              'ğŸ“ Detailed Terraform dependency graph is available in workflow artifacts for engineers.'
            ].join('\n');

            github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: body
            }); 
      
      # ------------------------------------------------------------
      # PR Comment â€“ Technical Graph (Engineers)
      # ------------------------------------------------------------
      - name: PR Comment â€“ Technical Graph (Engineers)
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.issue?.number) return;

            const body = [
              '### Terraform Dependency Graph (Technical)',
              '',
              'ğŸ“ **Download SVG:**',
              'Workflow run â†’ Artifacts â†’ terraform-plan-graph â†’ tfplan.svg',
              '',
              'âš ï¸ Apply & destroy are disabled in this workflow.'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
