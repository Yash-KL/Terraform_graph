name: Terraform PR Plan + Graph + Cost

on:
  pull_request:
    branches: [ main ]

env:
  TF_WORKING_DIR: .

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # GCP Authentication
      # ---------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ---------------------------
      # Terraform Setup
      # ---------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      # ---------------------------
      # Terraform Diff Summary
      # ---------------------------
      - name: Terraform diff summary
        id: diff
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          ADDED=$(jq '[.resource_changes[] | select(.change.actions | index("create"))] | length' tfplan.json)
          CHANGED=$(jq '[.resource_changes[] | select(.change.actions | index("update"))] | length' tfplan.json)
          DESTROYED=$(jq '[.resource_changes[] | select(.change.actions | index("delete"))] | length' tfplan.json)

          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
          echo "destroyed=$DESTROYED" >> $GITHUB_OUTPUT

      # ---------------------------
      # Graphviz (Colorful Graph)
      # ---------------------------
      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Generate Terraform graph (styled)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform graph -plan=tfplan.binary \
          | sed 's/graph \[/graph [rankdir=LR, bgcolor="white", /' \
          > tfplan.dot

          dot -Tpng \
            -Nstyle=filled \
            -Nfillcolor="#E3F2FD" \
            -Ncolor="#1565C0" \
            -Ecolor="#90CAF9" \
            tfplan.dot -o tfplan.png
      # ---------------------------
      # Upload Artifacts
      # ---------------------------
      - name: Upload plan, graph and cost as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-graph-cost
          path: |
            tfplan.binary
            tfplan.json
            tfplan.dot
            tfplan.png
            infracost.json
          retention-days: 7

      # ---------------------------
      # PR Comment (Single Source of Truth)
      # ---------------------------
      - name: Comment on PR with plan & cost summary
        uses: actions/github-script@v7
        with:
          script: |
            const added = "${{ steps.diff.outputs.added }}";
            const changed = "${{ steps.diff.outputs.changed }}";
            const destroyed = "${{ steps.diff.outputs.destroyed }}";
            const monthly = "${{ steps.cost.outputs.monthly }}";

            const runUrl =
              `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `
## Terraform Plan Review

### Resource changes
- ðŸŸ¢ **Add:** ${added}
- ðŸŸ¡ **Change:** ${changed}
- ðŸ”´ **Destroy:** ${destroyed}

### Estimated Monthly Cost
- ðŸ’° **$${monthly} / month**

### Visual Graph
Download artifact **terraform-plan-graph-cost**  
Open **tfplan.png** to view the architecture graph.

ðŸ”— **Workflow run:** ${runUrl}

âœ… Please review before approving this PR.
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
