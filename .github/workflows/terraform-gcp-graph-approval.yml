name: Terraform PR Plan + Graph

on:
  pull_request:
    branches: [ main ]

env:
  TF_WORKING_DIR: .

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Authenticate to Google Cloud
      # -------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # -------------------------------------------------
      # Terraform setup
      # -------------------------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # -------------------------------------------------
      # Terraform Plan
      # -------------------------------------------------
      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      # -------------------------------------------------
      # Install Graphviz
      # -------------------------------------------------
      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      # -------------------------------------------------
      # Generate Colorful Terraform Graph
      # -------------------------------------------------
      - name: Generate Terraform graph (colorful)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform graph -plan=tfplan.binary \
          | sed 's/graph \[/graph [rankdir=LR, bgcolor="white", /' \
          > tfplan.dot

          dot -Tpng \
            -Nstyle=filled \
            -Nfillcolor="#E3F2FD" \
            -Ncolor="#1565C0" \
            -Ecolor="#90CAF9" \
            tfplan.dot -o tfplan.png

      # -------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------
      - name: Upload plan and graph artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-and-graph
          path: |
            tfplan.binary
            tfplan.json
            tfplan.dot
            tfplan.png

      # -------------------------------------------------
      # Comment on PR (graph only)
      # -------------------------------------------------
      - name: Comment on PR with graph info
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
## Terraform Plan â€“ Infrastructure Graph

A Terraform plan has been generated for this PR.

ðŸ“¦ **Artifacts**
Download **terraform-plan-and-graph**
and open **tfplan.png** to visually review the infrastructure changes.

ðŸ”— **Workflow run**
https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

âœ… Please review the graph and approve this PR.
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
